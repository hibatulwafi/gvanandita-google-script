<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <title>Dashboard Monitoring - Glory Victory Anandita</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
            color: #333;
            overflow-y: auto;
            max-height: calc(100vh - 40px);
            box-sizing: border-box;
        }

        .header {
            text-align: center;
            margin-bottom: 25px;
            padding: 15px 25px;
            background-color: #000;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 80px;
            flex-wrap: wrap;
        }

        .header-logo {
            max-width: 80px;
            height: auto;
            display: block;
            margin-right: 20px;
        }

        .header-title {
            color: #f8f9fa;
            margin: 0;
            font-size: 1.5em;
            text-align: left;
            flex-grow: 1;
        }

        .filters {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            background-color: #ffffff;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            justify-content: flex-end;
            gap: 15px;
            margin-bottom: 25px;
        }

        .filters label {
            font-weight: 600;
            color: #555;
            white-space: nowrap;
        }

        .filters select {
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid #cce0ff;
            background-color: #e6f0ff;
            font-size: 0.95em;
            cursor: pointer;
            outline: none;
            transition: border-color 0.3s;
            min-width: 120px;
        }

        .filters select:focus {
            border-color: #007bff;
        }

        .filter-group {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        /* Warna untuk Ikon */
        .icon-growth {
            color: #28a745;
        }

        .icon-target {
            color: #ffc107;
        }

        .icon-assets {
            color: #17a2b8;
        }

        .icon-inflow {
            color: #007bff;
        }

        .icon-outflow {
            color: #dc3545;
        }

        .icon-salary {
            color: #6f42c1;
        }

        .icon-marketers {
            color: #fd7e14;
        }

        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 20px 25px;
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 15px;
            transition: transform 0.2s ease-in-out;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card .main-icon {
            font-size: 3em;
            min-width: 60px;
            text-align: center;
        }

        .card-content-wrapper {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            flex-grow: 1;
        }

        .card-title {
            display: block;
            font-size: 1em;
            color: #000;
            margin-bottom: 5px;
            font-weight: 600;
            text-align: left;
        }

        .card-value {
            font-size: 1.4em;
            font-weight: 700;
            color: #000;
            word-break: break-word;
            text-align: left;
        }

        .card-value.negative {
            color: #dc3545;
        }

        .tabs-container {
            display: flex;
            justify-content: center;
            margin-bottom: 25px;
            background-color: #e9ecef;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .tab-button {
            flex-grow: 1;
            padding: 12px 20px;
            border: none;
            background-color: transparent;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            color: #555;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            text-align: center;
        }

        .tab-button:hover:not(.active) {
            background-color: #dee2e6;
            color: #333;
        }

        .tab-button.active {
            background-color: #007bff;
            color: white;
            border-bottom: 3px solid #0056b3;
        }

        .tab-content {
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 25px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .performance-section h3 {
            margin-top: 0;
            color: #0056b3;
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        table th,
        table td {
            border: 1px solid #eee;
            padding: 10px;
            text-align: left;
            font-size: 0.9em;
        }

        table thead {
            position: sticky;
            top: 0;
            background-color: #e9ecef;
            z-index: 1;
        }

        table th {
            background-color: #e9ecef;
            font-weight: 600;
            color: #495057;
        }

        table tbody {
            display: block;
            max-height: 300px;
            overflow-y: auto;
        }

        table thead tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }

        table tbody tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }


        .chart-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }

        .chart-box {
            flex: 1 1 48%;
            min-width: 300px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 20px;
            min-height: 300px;
            display: flex;
            flex-direction: column;
        }

        .chart-box h4 {
            text-align: center;
            color: #0056b3;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        canvas {
            max-height: 350px;
            width: 100% !important;
            height: auto !important;
            flex-grow: 1;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 1.5em;
            color: #007bff;
            z-index: 1000;
            display: none;
            text-align: center;
        }

        .loading-overlay img {
            width: 80px;
            margin-bottom: 15px;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {

            .cards-container,
            .chart-container {
                grid-template-columns: 1fr;
            }

            .chart-box {
                flex-basis: 100%;
            }

            .filters {
                flex-direction: column;
                align-items: stretch;
                padding: 15px;
                justify-content: flex-start;
                gap: 10px;
            }

            .filter-group {
                flex-direction: column;
                align-items: stretch;
                width: 100%;
                gap: 10px;
                margin-right: 0;
            }

            .filters label {
                margin-bottom: 5px;
                text-align: left;
            }

            .filters select {
                width: 100%;
                box-sizing: border-box;
            }

            .card {
                flex-direction: row;
                justify-content: flex-start;
                padding: 15px;
            }

            .card .main-icon {
                font-size: 2.5em;
                min-width: 50px;
            }
        }
    </style>
</head>

<body>
    <div class="loading-overlay" id="loadingOverlay">
        <img src="https://upload.wikimedia.org/wikipedia/commons/b/b1/Loading_icon.gif" alt="Loading..." />
        Memuat Dashboard...
    </div>

    <div class="header">
        <img src="https://www.gvanandita.com/images/white-logo.png" alt="Glory Victory Anandita Logo" class="header-logo">
        <h1 class="header-title">Dashboard Monitoring - Glory Victory Anandita</h1>
    </div>

    <div class="filters">
        <label for="periodTypeFilter">Tipe Periode:</label>
        <select id="periodTypeFilter" onchange="togglePeriodFilters()">
            <option value="monthly" selected>Bulanan</option>
            <option value="weekly">Mingguan</option>
        </select>

        <div id="monthlyFilters" class="filter-group">
            <label for="monthFilter">Bulan:</label>
            <select id="monthFilter" onchange="updateDashboardView()"></select>
            <label for="yearFilter">Tahun:</label>
            <select id="yearFilter" onchange="updateDashboardView()"></select>
        </div>

        <div id="weeklyFilters" class="filter-group" style="display:none;">
            <label for="weekNumberFilter">Minggu Ke-:</label>
            <select id="weekNumberFilter" onchange="updateDashboardView()"></select>
            <label for="weeklyYearFilter">Tahun:</label>
            <select id="weeklyYearFilter" onchange="updateDashboardView()"></select>
        </div>

        <label for="marketingFilter">Marketing:</label>
        <select id="marketingFilter" onchange="updateDashboardView()">
            <option value="All">Semua Marketing</option>
        </select>
    </div>

    <div class="cards-container">
        <div class="card">
            <i class="fas fa-chart-line main-icon icon-growth"></i>
            <div class="card-content-wrapper">
                <div class="card-title">Total Growth</div>
                <div class="card-value" id="totalGrowth">Rp0</div>
            </div>
        </div>
        <div class="card">
            <i class="fas fa-bullseye main-icon icon-target"></i>
            <div class="card-content-wrapper">
                <div class="card-title">Overall Target %</div>
                <div class="card-value" id="overallTarget">0%</div>
            </div>
        </div>

        <div class="card">
            <i class="fas fa-arrow-alt-circle-down main-icon icon-inflow"></i>
            <div class="card-content-wrapper">
                <div class="card-title">Total Inflow</div>
                <div class="card-value" id="totalInflow">Rp0</div>
            </div>
        </div>
        <div class="card">
            <i class="fas fa-arrow-alt-circle-up main-icon icon-outflow"></i>
            <div class="card-content-wrapper">
                <div class="card-title">Total Outflow</div>
                <div class="card-value" id="totalOutflow">Rp0</div>
            </div>
        </div>
    </div>

    <div class="cards-container">
        <div class="card">
            <i class="fas fa-hand-holding-usd main-icon icon-salary"></i>
            <div class="card-content-wrapper">
                <div class="card-title">Total Gaji</div>
                <div class="card-value" id="totalGaji">Rp0</div>
            </div>
        </div>
        <div class="card">
            <i class="fas fa-wallet main-icon icon-salary"></i>
            <div class="card-content-wrapper">
                <div class="card-title">Total Komisi</div>
                <div class="card-value" id="totalKomisi">Rp0</div>
            </div>
        </div>
        <div class="card">
            <i class="fas fa-user-plus main-icon icon-marketers"></i>
            <div class="card-content-wrapper">
                <div class="card-title">Total Prospect</div>
                <div class="card-value" id="totalProspect">0</div>
            </div>
        </div>
        <div class="card">
            <i class="fas fa-users main-icon icon-marketers"></i>
            <div class="card-content-wrapper">
                <div class="card-title">Total Closing</div>
                <div class="card-value" id="totalClosing">0</div>
            </div>
        </div>
    </div>

    <div class="tabs-container">
        <button class="tab-button active" onclick="openTab(event, 'laporanUtama')">Laporan Utama</button>
        <button class="tab-button" onclick="openTab(event, 'analisisVisual')">Analisis Visual</button>
        <button class="tab-button" onclick="openTab(event, 'perhitunganGaji')">Perhitungan Gaji & Komisi</button>
    </div>

    <div id="laporanUtama" class="tab-content active">
        <h3>Performance Marketing</h3>
        <table>
            <thead>
                <tr>
                    <th>Nama Marketing</th>
                    <th>Pencapaian (%)</th>
                    <th>Total Komisi (Rp)</th>
                    <th>Total Closing (Rp)</th>
                    <th>Prospect Berjalan</th>
                </tr>
            </thead>
            <tbody id="performanceTableBody">
                </tbody>
        </table>
        <h3 style="margin-top: 30px;">Marketing dengan Pertumbuhan Negatif</h3>
        <table>
            <thead>
                <tr>
                    <th>Nama Marketing</th>
                    <th>Total Growth (Rp)</th>
                </tr>
            </thead>
            <tbody id="negativeGrowthTableBody">
                </tbody>
        </table>
    </div>

    <div id="analisisVisual" class="tab-content">
        <h3>Analisis Visual Performance Marketing</h3>
        <div class="chart-container">
            <div class="chart-box">
                <h4>Performance (%) Marketing</h4>
                <canvas id="performanceChart"></canvas>
            </div>
            <div class="chart-box">
                <h4>Total Inflow per Marketing</h4>
                <canvas id="inflowChart"></canvas>
            </div>
        </div>
        <div class="chart-container">
            <div class="chart-box">
                <h4>Total Prospect per Marketing</h4>
                <canvas id="prospectChart"></canvas>
            </div>
            <div class="chart-box">
                <h4>Total Closing per Marketing</h4>
                <canvas id="closingChart"></canvas>
            </div>
        </div>
    </div>

    <div id="perhitunganGaji" class="tab-content">
        <h3>Perhitungan Gaji dan Komisi Marketing</h3>
        <table>
            <thead>
                <tr>
                    <th>Nama Marketing</th>
                    <th>Gaji Kontrak (Rp)</th>
                    <th>Total Gaji (Rp)</th>
                    <th>Komisi Fee Cair (Rp)</th>
                    <th>Reward Tambahan (Rp)</th>
                    <th>Total Komisi (Rp)</th>
                    <th>Total Dibayarkan (Rp)</th>
                </tr>
            </thead>
            <tbody id="gajiKomisiTableBody">
                <tr>
                    <td colspan="7" style="text-align: center;">Memuat data...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <script>
        const monthNames = [
            'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli',
            'Agustus', 'September', 'Oktober', 'November', 'Desember'
        ];

        let currentCharts = {}; // Object to hold Chart.js instances

        function toggleLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        document.addEventListener('DOMContentLoaded', function() {
            populateFilters();
            populateWeeklyFilters();
            // Set default period to current month/year on load
            const today = new Date();
            document.getElementById('monthFilter').value = today.getMonth() + 1;
            document.getElementById('yearFilter').value = today.getFullYear();

            updateDashboardView(); // Initial load
            openTab(null, 'laporanUtama'); // Open default tab
        });

        function populateFilters() {
            const monthFilter = document.getElementById('monthFilter');
            const yearFilter = document.getElementById('yearFilter');
            const marketingFilter = document.getElementById('marketingFilter');
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth();

            // Populate Month Filter
            monthNames.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = index + 1; // Use 1-based index for month
                option.textContent = month;
                if (index === currentMonth) option.selected = true;
                monthFilter.appendChild(option);
            });

            // Populate Year Filter (monthly)
            for (let i = currentYear - 5; i <= currentYear + 2; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                if (i === currentYear) option.selected = true;
                yearFilter.appendChild(option);
            }

            // Populate Marketing Filter - This will be fetched from server
            google.script.run
                .withSuccessHandler(function(marketingNames) {
                    // Clear existing options except 'All'
                    marketingFilter.innerHTML = '<option value="All">Semua Marketing</option>';
                    marketingNames.forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        marketingFilter.appendChild(option);
                    });
                })
                .withFailureHandler(handleError)
                .getAllMarketingNames(); // Make sure you have this function in Code.gs
        }

        function populateWeeklyFilters() {
            const weekNumberFilter = document.getElementById('weekNumberFilter');
            const weeklyYearFilter = document.getElementById('weeklyYearFilter');
            const currentYear = new Date().getFullYear();

            // Populate Week Number Filter (assuming 52 weeks)
            weekNumberFilter.innerHTML = ''; // Clear existing options first
            for (let i = 1; i <= 52; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Minggu ${i}`;
                weekNumberFilter.appendChild(option);
            }

            // Populate Year Filter (weekly)
            weeklyYearFilter.innerHTML = ''; // Clear existing options first
            for (let i = currentYear - 5; i <= currentYear + 2; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                if (i === currentYear) option.selected = true;
                weeklyYearFilter.appendChild(option);
            }
        }


        function togglePeriodFilters() {
            const periodType = document.getElementById('periodTypeFilter').value;
            const monthlyFilters = document.getElementById('monthlyFilters');
            const weeklyFilters = document.getElementById('weeklyFilters');

            if (periodType === 'monthly') {
                monthlyFilters.style.display = 'flex';
                weeklyFilters.style.display = 'none';
            } else { // weekly
                monthlyFilters.style.display = 'none';
                weeklyFilters.style.display = 'flex';
            }
            updateDashboardView(); // Refresh data based on new period type
        }

        function updateDashboardView() {
            toggleLoading(true);

            const periodType = document.getElementById('periodTypeFilter').value;
            const selectedMarketing = document.getElementById('marketingFilter').value;

            let month = null;
            let year = null;
            let weekNumber = null;
            let weeklyYear = null;

            if (periodType === 'monthly') {
                month = parseInt(document.getElementById('monthFilter').value);
                year = parseInt(document.getElementById('yearFilter').value);
            } else { // weekly
                weekNumber = parseInt(document.getElementById('weekNumberFilter').value);
                weeklyYear = parseInt(document.getElementById('weeklyYearFilter').value);
            }

            google.script.run
                .withSuccessHandler(displayDashboardData)
                .withFailureHandler(handleError)
                .getDashboardData(month, year, selectedMarketing, periodType, weekNumber, weeklyYear);
        }

        function displayDashboardData(data) {
            toggleLoading(false);
            window.dashboardData = data; // Store globally for chart rendering

            if (data && data.summary) {
                document.getElementById('totalGrowth').textContent = formatCurrency(data.summary.totalGrowth);
                document.getElementById('totalGrowth').classList.toggle('negative', data.summary.totalGrowth < 0);
                document.getElementById('overallTarget').textContent = data.summary.overallTargetPercentage.toFixed(2) + '%';
                document.getElementById('totalInflow').textContent = formatCurrency(data.summary.totalInflow);
                document.getElementById('totalOutflow').textContent = formatCurrency(data.summary.totalOutflow);
                document.getElementById('totalOutflow').classList.toggle('negative', data.summary.totalOutflow < 0);
                document.getElementById('totalGaji').textContent = formatCurrency(data.summary.totalGaji);
                document.getElementById('totalKomisi').textContent = formatCurrency(data.summary.totalKomisi);
                document.getElementById('totalProspect').textContent = data.summary.totalProspect;
                document.getElementById('totalClosing').textContent = data.summary.totalClosing;
                // document.getElementById('activeMarketers').textContent = data.summary.activeMarketers; // This element doesn't exist in HTML

                // Tampilkan data performance
                const performanceTableBody = document.getElementById('performanceTableBody');
                if (performanceTableBody) {
                    performanceTableBody.innerHTML = ''; // Bersihkan isi tabel sebelumnya
                    if (data.performanceData && data.performanceData.length > 0) {
                        data.performanceData.forEach(item => {
                            const row = performanceTableBody.insertRow();
                            row.insertCell(0).textContent = item.name;
                            row.insertCell(1).textContent = item.performance.toFixed(2) + '%';
                            row.insertCell(2).textContent = formatCurrency(item.commission);
                            row.insertCell(3).textContent = formatCurrency(item.totalInflow); // Total Closing (Inflow)
                            row.insertCell(4).textContent = item.totalProspect; // Prospect Berjalan
                        });
                    } else {
                        performanceTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Tidak ada data performance untuk periode ini.</td></tr>';
                    }
                } else {
                    console.error("Elemen 'performanceTableBody' tidak ditemukan.");
                }

                // Tampilkan data gaji dan komisi
                const gajiKomisiTableBody = document.getElementById('gajiKomisiTableBody');
                if (gajiKomisiTableBody) {
                    gajiKomisiTableBody.innerHTML = '';
                    if (data.gajiKomisiData && data.gajiKomisiData.length > 0) {
                        data.gajiKomisiData.forEach(item => {
                            const row = gajiKomisiTableBody.insertRow();
                            row.insertCell(0).textContent = item.name;
                            row.insertCell(1).textContent = formatCurrency(item.gajiKontrakAwal);
                            row.insertCell(2).textContent = formatCurrency(item.gajiFinal);
                            row.insertCell(3).textContent = formatCurrency(item.feeMarketingCair);
                            row.insertCell(4).textContent = formatCurrency(item.rewardTambahan);
                            row.insertCell(5).textContent = formatCurrency(item.totalKomisi);
                            row.insertCell(6).textContent = formatCurrency(item.totalDibayarkan);
                        });
                    } else {
                        gajiKomisiTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Tidak ada data gaji dan komisi untuk periode ini.</td></tr>';
                    }
                } else {
                    console.error("Elemen 'gajiKomisiTableBody' tidak ditemukan.");
                }

                // Tampilkan data Negative Growth Table
                const negativeGrowthTableBody = document.getElementById('negativeGrowthTableBody');
                if (negativeGrowthTableBody) {
                    negativeGrowthTableBody.innerHTML = '';
                    if (data.negativeGrowth && data.negativeGrowth.length > 0) {
                        data.negativeGrowth.forEach(item => {
                            const row = negativeGrowthTableBody.insertRow();
                            row.insertCell(0).textContent = item.name;
                            row.insertCell(1).textContent = formatCurrency(item.performance); // Assuming performance here is growth (Rp)
                        });
                    } else {
                        negativeGrowthTableBody.innerHTML = '<tr><td colspan="2" style="text-align: center;">Tidak ada marketing dengan pertumbuhan negatif.</td></tr>';
                    }
                } else {
                    console.error("Elemen 'negativeGrowthTableBody' tidak ditemukan.");
                }

                // Render charts when data is available
                renderCharts(data);

            } else {
                console.error("Data ringkasan tidak ditemukan atau kosong:", data);
                // Clear all elements if data is null or summary is missing
                document.getElementById('totalGrowth').textContent = 'Rp0';
                document.getElementById('overallTarget').textContent = '0%';
                document.getElementById('totalInflow').textContent = 'Rp0';
                document.getElementById('totalOutflow').textContent = 'Rp0';
                document.getElementById('totalGaji').textContent = 'Rp0';
                document.getElementById('totalKomisi').textContent = 'Rp0';
                document.getElementById('totalProspect').textContent = '0';
                document.getElementById('totalClosing').textContent = '0';
                // document.getElementById('activeMarketers').textContent = '0'; // This element doesn't exist in HTML
                document.getElementById('performanceTableBody').innerHTML = '<tr><td colspan="5" style="text-align: center;">Tidak ada data yang tersedia.</td></tr>';
                document.getElementById('negativeGrowthTableBody').innerHTML = '<tr><td colspan="2" style="text-align: center;">Tidak ada data.</td></tr>';
                document.getElementById('gajiKomisiTableBody').innerHTML = '<tr><td colspan="7" style="text-align: center;">Tidak ada data.</td></tr>';

                // Destroy existing charts
                for (const chartId in currentCharts) {
                    if (currentCharts[chartId]) {
                        currentCharts[chartId].destroy();
                        currentCharts[chartId] = null;
                    }
                }
            }
        }

        function handleError(error) {
            toggleLoading(false);
            alert('Terjadi kesalahan saat memuat data: ' + error.message);
            console.error(error);
        }

        function formatCurrency(amount) {
            if (typeof amount !== 'number' || isNaN(amount)) return 'Rp0'; // Handle non-numeric or NaN input
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        // --- Tab Management ---
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
                tabcontent[i].classList.remove('active');
            }
            tablinks = document.getElementsByClassName("tab-button");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }

            const selectedTab = document.getElementById(tabName);
            if (selectedTab) {
                selectedTab.style.display = "block";
                selectedTab.classList.add('active');
            }
            if (evt) { // Only add active class if clicked
                evt.currentTarget.className += " active";
            } else { // For initial load, set active class on the default button
                const defaultButton = document.querySelector(`.tab-button[onclick*='${tabName}']`);
                if (defaultButton) {
                    defaultButton.className += " active";
                }
            }

            // If "Analisis Visual" tab is opened, render charts
            if (tabName === 'analisisVisual' && window.dashboardData) {
                renderCharts(window.dashboardData);
            } else {
                // Destroy charts if switching away from Analisis Visual tab
                for (const chartId in currentCharts) {
                    if (currentCharts[chartId]) {
                        currentCharts[chartId].destroy();
                        currentCharts[chartId] = null;
                    }
                }
            }
        }


        // --- Chart Rendering Functions ---
        function renderCharts(data) {
            // Destroy existing charts before rendering new ones
            for (const chartId in currentCharts) {
                if (currentCharts[chartId]) {
                    currentCharts[chartId].destroy();
                    currentCharts[chartId] = null;
                }
            }

            if (!data || !data.performanceData || data.performanceData.length === 0) {
                console.warn("Tidak ada data performance untuk merender grafik.");
                // Optionally display a message in the chart areas
                document.getElementById('performanceChart').getContext('2d').clearRect(0, 0, document.getElementById('performanceChart').width, document.getElementById('performanceChart').height);
                document.getElementById('inflowChart').getContext('2d').clearRect(0, 0, document.getElementById('inflowChart').width, document.getElementById('inflowChart').height);
                document.getElementById('prospectChart').getContext('2d').clearRect(0, 0, document.getElementById('prospectChart').width, document.getElementById('prospectChart').height);
                document.getElementById('closingChart').getContext('2d').clearRect(0, 0, document.getElementById('closingChart').width, document.getElementById('closingChart').height);
                return;
            }

            const marketingNames = data.performanceData.map(item => item.name);
            const performancePercentages = data.performanceData.map(item => item.performance);
            const totalInflows = data.performanceData.map(item => item.totalInflow);
            const totalProspects = data.performanceData.map(item => item.totalProspect);
            const totalClosings = data.performanceData.map(item => item.totalClosing);

            // Chart 1: Performance (%) Marketing
            const performanceCtx = document.getElementById('performanceChart').getContext('2d');
            currentCharts.performanceChart = new Chart(performanceCtx, {
                type: 'bar',
                data: {
                    labels: marketingNames,
                    datasets: [{
                        label: 'Pencapaian (%)',
                        data: performancePercentages,
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Pencapaian (%)'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.raw.toFixed(2) + '%';
                                }
                            }
                        }
                    }
                }
            });

            // Chart 2: Total Inflow per Marketing
            const inflowCtx = document.getElementById('inflowChart').getContext('2d');
            currentCharts.inflowChart = new Chart(inflowCtx, {
                type: 'bar',
                data: {
                    labels: marketingNames,
                    datasets: [{
                        label: 'Total Inflow (Rp)',
                        data: totalInflows,
                        backgroundColor: 'rgba(153, 102, 255, 0.6)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Total Inflow (Rp)'
                            },
                            ticks: {
                                callback: function(value, index, values) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.raw);
                                }
                            }
                        }
                    }
                }
            });

            // Chart 3: Total Prospect per Marketing
            const prospectCtx = document.getElementById('prospectChart').getContext('2d');
            currentCharts.prospectChart = new Chart(prospectCtx, {
                type: 'bar',
                data: {
                    labels: marketingNames,
                    datasets: [{
                        label: 'Jumlah Prospect',
                        data: totalProspects,
                        backgroundColor: 'rgba(255, 159, 64, 0.6)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Jumlah Prospect'
                            },
                            ticks: {
                                precision: 0 // Ensure whole numbers for counts
                            }
                        }
                    }
                }
            });

            // Chart 4: Total Closing per Marketing
            const closingCtx = document.getElementById('closingChart').getContext('2d');
            currentCharts.closingChart = new Chart(closingCtx, {
                type: 'bar',
                data: {
                    labels: marketingNames,
                    datasets: [{
                        label: 'Jumlah Closing',
                        data: totalClosings,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Jumlah Closing'
                            },
                            ticks: {
                                precision: 0 // Ensure whole numbers for counts
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>

</html>