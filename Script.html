<script>
  const monthNames = [
    'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli',
    'Agustus', 'September', 'Oktober', 'November', 'Desember'
  ];

  let currentCharts = {};

  function toggleLoading(show) {
    document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
  }

  document.addEventListener('DOMContentLoaded', function() {
    populateFilters();
    populateWeeklyFilters();
    // Set default period to current month/year on load
    const today = new Date();
    document.getElementById('monthFilter').value = today.getMonth() + 1;
    document.getElementById('yearFilter').value = today.getFullYear();

    updateDashboardView();
    openTab(null, 'laporanUtama');
    openAbsensiTab(null,'monthlyAbsensi');
    openReportTab(null,'performanceMarketing');
    openGajiTab(null,'gajiMarketing');
  });

  function populateFilters() {
    const monthFilter = document.getElementById('monthFilter');
    const yearFilter = document.getElementById('yearFilter');
    const marketingFilter = document.getElementById('marketingFilter');
    const currentYear = new Date().getFullYear();
    const currentMonth = new Date().getMonth();

    // Populate Month Filter
    monthNames.forEach((month, index) => {
      const option = document.createElement('option');
      option.value = index + 1; // Use 1-based index for month
      option.textContent = month;
      if (index === currentMonth) option.selected = true;
      monthFilter.appendChild(option);
    });

    // Populate Year Filter (monthly)
    for (let i = currentYear - 5; i <= currentYear + 2; i++) {
      const option = document.createElement('option');
      option.value = i;
      option.textContent = i;
      if (i === currentYear) option.selected = true;
      yearFilter.appendChild(option);
    }

    // Populate Marketing Filter - This will be fetched from server
    google.script.run
      .withSuccessHandler(function(marketingNames) {
        // Clear existing options except 'All'
        marketingFilter.innerHTML = '<option value="All">Semua Marketing</option>';
        marketingNames.forEach(name => {
          const option = document.createElement('option');
          option.value = name;
          option.textContent = name;
          marketingFilter.appendChild(option);
        });
      })
      .withFailureHandler(handleError)
      .getAllMarketingNames(); // Make sure you have this function in Code.gs
  }

  function populateWeeklyFilters() {
    const weekNumberFilter = document.getElementById('weekNumberFilter');
    const weeklyYearFilter = document.getElementById('weeklyYearFilter');
    const currentYear = new Date().getFullYear();

    // Populate Week Number Filter (assuming 52 weeks)
    weekNumberFilter.innerHTML = ''; // Clear existing options first
    for (let i = 1; i <= 52; i++) {
      const option = document.createElement('option');
      option.value = i;
      option.textContent = `Minggu ${i}`;
      weekNumberFilter.appendChild(option);
    }

    // Populate Year Filter (weekly)
    weeklyYearFilter.innerHTML = ''; // Clear existing options first
    for (let i = currentYear - 5; i <= currentYear + 2; i++) {
      const option = document.createElement('option');
      option.value = i;
      option.textContent = i;
      if (i === currentYear) option.selected = true;
      weeklyYearFilter.appendChild(option);
    }
  }


  function togglePeriodFilters() {
    const periodType = document.getElementById('periodTypeFilter').value;
    const monthlyFilters = document.getElementById('monthlyFilters');
    const weeklyFilters = document.getElementById('weeklyFilters');

    if (periodType === 'monthly') {
      monthlyFilters.style.display = 'flex';
      weeklyFilters.style.display = 'none';
    } else { // weekly
      monthlyFilters.style.display = 'none';
      weeklyFilters.style.display = 'flex';
    }
    updateDashboardView(); // Refresh data based on new period type
  }

  function updateDashboardView() {
    toggleLoading(true);

    const periodType = document.getElementById('periodTypeFilter').value;
    const selectedMarketing = document.getElementById('marketingFilter').value;

    let month = null;
    let year = null;
    let weekNumber = null;
    let weeklyYear = null;

    if (periodType === 'monthly') {
      month = parseInt(document.getElementById('monthFilter').value);
      year = parseInt(document.getElementById('yearFilter').value);
    } else { // weekly
      weekNumber = parseInt(document.getElementById('weekNumberFilter').value);
      weeklyYear = parseInt(document.getElementById('weeklyYearFilter').value);
    }

    google.script.run
      .withSuccessHandler(displayDashboardData)
      .withFailureHandler(handleError)
      .getDashboardData(month, year, selectedMarketing, periodType, weekNumber, weeklyYear);
  }

  function displayDashboardData(data) {
    toggleLoading(false);
    window.dashboardData = data; // Store globally for chart rendering

    if (data) { // Cek data secara keseluruhan, bukan hanya summary
      // Bagian Summary Cards
      if (data && data.summary) {
        document.getElementById('totalGrowth').textContent = formatCurrency(data.summary.totalGrowth);
        document.getElementById('totalGrowth').classList.toggle('negative', data.summary.totalGrowth < 0);

        document.getElementById('overallTarget').textContent = data.summary.overallTargetPercentage.toFixed(2) + '%';

        document.getElementById('totalInflow').textContent = formatCurrency(data.summary.totalInflow);

        // BARU: Closing Rate
        // Pastikan ID di HTML adalah 'closingRateDisplay'
        const closingRate = data.summary.closingRate !== undefined ? data.summary.closingRate : 0;
        document.getElementById('closingRateDisplay').textContent = closingRate.toFixed(2) + '%';

        // BARU: Gross Profit
        // Pastikan ID di HTML adalah 'grossProfit'
        document.getElementById('grossProfit').textContent = formatCurrency(data.summary.newCalculatedIncome);
        document.getElementById('grossProfit').classList.toggle('negative', data.summary.newCalculatedIncome < 0);

        document.getElementById('totalGaji').textContent = formatCurrency(data.summary.totalGaji);

        document.getElementById('totalKomisi').textContent = formatCurrency(data.summary.totalKomisi);

        // BARU: Net Profit
        // Pastikan ID di HTML adalah 'netProfit'
        document.getElementById('netProfit').textContent = formatCurrency(data.summary.netProfit);
        document.getElementById('netProfit').classList.toggle('negative', data.summary.netProfit < 0);

        // BARU: New Calculated Income (jika Anda ingin menampilkannya di card)
        // Jika Anda membuat card terpisah untuk ini, berikan ID di HTML
        // Misalnya, jika ada card dengan id="newCalculatedIncomeDisplay"
        // if (document.getElementById('newCalculatedIncomeDisplay')) {
        //     document.getElementById('newCalculatedIncomeDisplay').textContent = formatCurrency(data.summary.newCalculatedIncome);
        // }

    } else {
        // Handle case where summary data is missing or empty
        console.error("Data summary tidak ditemukan atau kosong. Mereset nilai card.");
        document.getElementById('totalGrowth').textContent = 'Rp0';
        document.getElementById('overallTarget').textContent = '0%';
        document.getElementById('totalInflow').textContent = 'Rp0';
        // BARU: Reset Closing Rate
        document.getElementById('closingRateDisplay').textContent = '0%';
        // BARU: Reset Gross Profit
        document.getElementById('grossProfit').textContent = 'Rp0';
        document.getElementById('totalGaji').textContent = 'Rp0';
        document.getElementById('totalKomisi').textContent = 'Rp0';
        // BARU: Reset Net Profit
        document.getElementById('netProfit').textContent = 'Rp0';
        // Jika Anda menambahkan card newCalculatedIncome, tambahkan reset di sini
        // if (document.getElementById('newCalculatedIncomeDisplay')) {
        //     document.getElementById('newCalculatedIncomeDisplay').textContent = 'Rp0';
        // }

        // Hapus baris di bawah ini jika elemen HTML-nya sudah tidak ada
        // document.getElementById('totalOutflow').textContent = 'Rp0';
        // document.getElementById('totalProspect').textContent = '0';
        // document.getElementById('totalClosing').textContent = '0';
    }

    function getDataTableOptions(colCount) {
        return {
            dom: 'Bfrtip',
            buttons: [
                { extend: 'copy', text: 'Copy' },
                { extend: 'csv', text: 'CSV' },
                { extend: 'excel', text: 'Excel' },
                { extend: 'pdf', text: 'PDF' },
                { extend: 'print', text: 'Print' }
            ],
            language: {
                url: '//cdn.datatables.net/plug-ins/2.0.8/i18n/id.json'
            },
            autoWidth: false,
            responsive: true,
        };
    }
    
      // Tampilkan data performance
      const performanceTableBody = document.getElementById('performanceTableBody');
      if (performanceTableBody) {
          const tableElement = $('#performanceTable');

          // Cek apakah tabel sudah memiliki instance DataTables.
          // Jika ada, hancurkan instance yang lama sebelum membersihkan tabel.
          if ($.fn.DataTable.isDataTable(tableElement)) {
              tableElement.DataTable().destroy();
          }

          // Bersihkan isi tabel sebelumnya
          performanceTableBody.innerHTML = '';

          if (data.performanceData && data.performanceData.length > 0) {
              data.performanceData.forEach(item => {
                  const row = performanceTableBody.insertRow();
                  row.insertCell(0).textContent = item.name;
                  row.insertCell(1).textContent = (item.performance).toFixed(2) + '%'; 
                  row.insertCell(2).textContent = formatCurrency(item.commission);
                  row.insertCell(3).textContent = formatCurrency(item.inflow);
                  row.insertCell(4).textContent = item.totalClosing;
                  row.insertCell(5).textContent = item.totalProspect;
              });
              
              // Inisialisasi ulang DataTables pada tabel yang baru diisi
              tableElement.DataTable(getDataTableOptions(6));
          } else {
              // PERBAIKI: Kolom harus 6, bukan 5
              performanceTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Tidak ada data performance untuk periode ini.</td></tr>';
          }
      } else {
          console.error("Elemen 'performanceTableBody' tidak ditemukan.");
      }

      const dataPinjamanTableBody = document.getElementById('dataPinjamanTableBody');
      if (dataPinjamanTableBody) {
          const tableElement = $('#dataPinjamanTable');

          // Cek apakah tabel sudah memiliki instance DataTables.
          // Jika ada, hancurkan instance yang lama sebelum membersihkan tabel.
          if ($.fn.DataTable.isDataTable(tableElement)) {
              tableElement.DataTable().destroy();
          }

          // Bersihkan isi tabel sebelumnya
          dataPinjamanTableBody.innerHTML = '';

          if (data.detailPinjamanData && data.detailPinjamanData.length > 0) {
              data.detailPinjamanData.forEach(item => {
                  const row = dataPinjamanTableBody.insertRow();
                  row.insertCell(0).textContent = item.debitur;
                  row.insertCell(1).textContent = item.telepon;
                  row.insertCell(2).textContent = item.nik;
                  row.insertCell(3).textContent = item.nopen;
                  row.insertCell(4).textContent = item.pekerjaan;
                  row.insertCell(5).textContent = item.alamat;
                  row.insertCell(6).textContent = formatCurrency(item.pinjamanDiterima);
                  row.insertCell(7).textContent = item.tanggalPencairan;
                  row.insertCell(8).textContent = item.channel;
                  row.insertCell(9).textContent = item.marketing;
                  row.insertCell(10).textContent = item.status;
              });
              
              // Inisialisasi ulang DataTables pada tabel yang baru diisi
              tableElement.DataTable(getDataTableOptions(11));
          } else {
              dataPinjamanTableBody.innerHTML = '<tr><td colspan="11" style="text-align: center;">Tidak ada data pinjaman untuk periode ini.</td></tr>';
          }
      }

      // Potential Table
      const potentialClosingBody = document.getElementById('potentialClosingBody');
      if (potentialClosingBody) {
          const tableElement = $('#potentialTable');
          // Cek apakah tabel sudah memiliki instance DataTables. Jika ada, hancurkan.
          if ($.fn.DataTable.isDataTable(tableElement)) {
              tableElement.DataTable().destroy();
          }

          // Bersihkan isi tabel sebelumnya
          potentialClosingBody.innerHTML = '';

          if (data.potensiPendapatanData && data.potensiPendapatanData.length > 0) {
              data.potensiPendapatanData.forEach(item => {
                  const row = potentialClosingBody.insertRow();
                  // Pastikan Anda selalu memasukkan 6 sel
                  row.insertCell(0).textContent = item.name || '';
                  row.insertCell(1).textContent = (item.performance ? item.performance.toFixed(2) : 0) + '%';
                  // row.insertCell(2).textContent = formatCurrency(item.commission || 0); // Komisi harusnya 0 untuk data potensi
                  row.insertCell(2).textContent = formatCurrency(item.inflow || 0);
                  // row.insertCell(4).textContent = item.totalClosing || 0;
                  // row.insertCell(5).textContent = item.totalProspect || 0;
              });

              // Inisialisasi ulang DataTables dengan 6 kolom
              tableElement.DataTable(getDataTableOptions(6));
          } else {
              // PERBAIKAN: colspan harus sesuai dengan jumlah kolom di header (6)
              potentialClosingBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Tidak ada data Potensi untuk periode ini.</td></tr>';
          }
      } else {
          console.error("Elemen 'potentialClosingBody' tidak ditemukan.");
      }

      // Tampilkan data gaji dan komisi
      const gajiKomisiTableBody = document.getElementById('gajiKomisiTableBody');
      if (gajiKomisiTableBody) {
          const tableElement = $('#gajiKomisiTable');

          // Cek apakah tabel sudah memiliki instance DataTables.
          // Jika ada, hancurkan instance yang lama sebelum membersihkan tabel.
          if ($.fn.DataTable.isDataTable(tableElement)) {
              tableElement.DataTable().destroy();
          }

          // Bersihkan isi tabel sebelumnya
          gajiKomisiTableBody.innerHTML = '';

          if (data.gajiKomisiData && data.gajiKomisiData.length > 0) {
              data.gajiKomisiData.forEach(item => {
                  const row = gajiKomisiTableBody.insertRow();
                  row.insertCell(0).textContent = item.name;
                  row.insertCell(1).textContent = formatCurrency(item.gajiKontrakAwal);
                  row.insertCell(2).textContent = formatCurrency(item.gajiFinal);
                  row.insertCell(3).textContent = formatCurrency(item.feeMarketingCair);
                  row.insertCell(4).textContent = formatCurrency(item.rewardTambahan);
                  row.insertCell(5).textContent = formatCurrency(item.totalKomisi);
                  row.insertCell(6).textContent = formatCurrency(item.totalDibayarkan);
              });

              // Inisialisasi ulang DataTables pada tabel yang baru diisi
              tableElement.DataTable(getDataTableOptions(7));
          } else {
              gajiKomisiTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Tidak ada data gaji dan komisi untuk periode ini.</td></tr>';
          }
      } else {
          console.error("Elemen 'gajiKomisiTableBody' tidak ditemukan.");
      }

      // Tampilkan data gaji dan komisi
      const gajiRecruiterTableBody = document.getElementById('gajiRecruiterTableBody');
      if (gajiRecruiterTableBody) {
          const tableElement = $('#gajiRecruiterTable');

          // Cek apakah tabel sudah memiliki instance DataTables.
          // Jika ada, hancurkan instance yang lama sebelum membersihkan tabel.
          if ($.fn.DataTable.isDataTable(tableElement)) {
              tableElement.DataTable().destroy();
          }

          // Bersihkan konten sebelumnya
          gajiRecruiterTableBody.innerHTML = ''; 

          // Data recruiterPerformance adalah objek, jadi kita ambil kuncinya (nama recruiter)
          if (data.recruiterPerformance && Object.keys(data.recruiterPerformance).length > 0) {
              const recruiterNames = Object.keys(data.recruiterPerformance).sort((a, b) => a.localeCompare(b));
              recruiterNames.forEach(recruiterName => {
                  const recruiterData = data.recruiterPerformance[recruiterName];
                  const row = gajiRecruiterTableBody.insertRow();
                  row.insertCell(0).textContent = recruiterName; // Nama Recruiter
                  row.insertCell(1).textContent = formatCurrency(recruiterData.totalKomisi); // Total Komisi Recruiter
              });
              
              // Inisialisasi ulang DataTables pada tabel yang baru diisi
              tableElement.DataTable(getDataTableOptions(2));
          } else {
              // Kolom untuk tabel recruiter hanya 2
              gajiRecruiterTableBody.innerHTML = '<tr><td colspan="2" style="text-align: center;">Tidak ada data komisi recruiter untuk periode ini.</td></tr>';
          }
      } else {
          console.error("Elemen 'gajiRecruiterTableBody' tidak ditemukan.");
      }

      // --- Perbaikan pada kode tabel Absensi ---
      const absensiTableBody = document.getElementById('absensiTableBody');
      if (absensiTableBody) {
          const tableElement = $('#absensiTable');

          // Cek apakah tabel sudah memiliki instance DataTables.
          // Jika ada, hancurkan.
          if ($.fn.DataTable.isDataTable(tableElement)) {
              tableElement.DataTable().destroy();
          }

          // Bersihkan isi tabel sebelumnya
          absensiTableBody.innerHTML = '';

          if (data.absensiData && data.absensiData.length > 0) {
              let no = 1;
              data.absensiData.forEach(item => {
                  const row = absensiTableBody.insertRow();
                  row.insertCell(0).textContent = no++;
                  row.insertCell(1).textContent = item.name;
                  row.insertCell(2).textContent = item.jumlahHariKerja;
                  row.insertCell(3).textContent = item.totalKunjungan;
                  row.insertCell(4).textContent = Math.ceil(item.presentase) + '%';
              });

              // Inisialisasi ulang DataTables
              tableElement.DataTable(getDataTableOptions(5));
          } else {
              absensiTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Tidak ada data absensi untuk periode ini.</td></tr>';
          }
      } else {
          console.error("Elemen 'absensiTableBody' tidak ditemukan.");
      }

      // --- Perbaikan pada kode tabel Daily ---
      const absensiDailyTableBody = document.getElementById('absensiDailyTableBody');
      if (absensiDailyTableBody) {
          const tableElement = $('#absensiDailyTable');

          // Cek apakah tabel sudah memiliki instance DataTables.
          // Jika ada, hancurkan.
          if ($.fn.DataTable.isDataTable(tableElement)) {
              tableElement.DataTable().destroy();
          }

          // Bersihkan isi tabel sebelumnya
          absensiDailyTableBody.innerHTML = '';

          if (data.absensiDailyData && data.absensiDailyData.length > 0) {
              let no = 1;
              data.absensiDailyData.forEach(item => {
                  const row = absensiDailyTableBody.insertRow();
                  row.insertCell(0).textContent = no++;
                  row.insertCell(1).textContent = item.name;
                  row.insertCell(2).textContent = item.tanggal;
                  row.insertCell(3).textContent = item.namaAnggotaCalonAnggota;
                  row.insertCell(4).textContent = item.alamat;
                  row.insertCell(5).textContent = item.fuVia;
                  row.insertCell(6).textContent = item.keterangan;
                  row.insertCell(7).textContent = item.hasilKunjungan;
              });

              // Inisialisasi ulang DataTables
              tableElement.DataTable(getDataTableOptions(8));
          } else {
              absensiDailyTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Tidak ada data absensi untuk periode ini.</td></tr>';
          }
      } else {
          console.error("Elemen 'absensiDailyTableBody' tidak ditemukan.");
      }

      // Render charts when data is available (jika tab analisis visual aktif)
      if (document.getElementById('analisisVisual').classList.contains('active')) {
        renderCharts(data);
      } else {
        // Destroy existing charts if not on analysis tab
        for (const chartId in currentCharts) {
          if (currentCharts[chartId]) {
            currentCharts[chartId].destroy();
            currentCharts[chartId] = null;
          }
        }
      }

    } else {
      console.error("Data dashboard tidak ditemukan atau kosong.");
      // Clear all elements if data is null or summary is missing
      document.getElementById('totalGrowth').textContent = 'Rp0';
      document.getElementById('overallTarget').textContent = '0%';
      document.getElementById('totalInflow').textContent = 'Rp0';
      document.getElementById('totalOutflow').textContent = 'Rp0';
      document.getElementById('totalGaji').textContent = 'Rp0';
      document.getElementById('totalKomisi').textContent = 'Rp0';
      document.getElementById('totalProspect').textContent = '0';
      document.getElementById('totalClosing').textContent = '0';
      document.getElementById('performanceTableBody').innerHTML = '<tr><td colspan="5" style="text-align: center;">Tidak ada data yang tersedia.</td></tr>';
      document.getElementById('negativeGrowthTableBody').innerHTML = '<tr><td colspan="2" style="text-align: center;">Tidak ada data.</td></tr>';
      document.getElementById('gajiKomisiTableBody').innerHTML = '<tr><td colspan="7" style="text-align: center;">Tidak ada data.</td></tr>';
      document.getElementById('absensiTableBody').innerHTML = '<tr><td colspan="4" style="text-align: center;">Tidak ada data.</td></tr>';

      // Destroy existing charts
      for (const chartId in currentCharts) {
        if (currentCharts[chartId]) {
          currentCharts[chartId].destroy();
          currentCharts[chartId] = null;
        }
      }
    }
  }

  function handleError(error) {
    toggleLoading(false);
    alert('Terjadi kesalahan saat memuat data: ' + error.message);
    console.error(error);
  }

  function formatCurrency(amount) {
    if (typeof amount !== 'number' || isNaN(amount)) return 'Rp0'; // Handle non-numeric or NaN input
    return new Intl.NumberFormat('id-ID', {
      style: 'currency',
      currency: 'IDR',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    }).format(amount);
  }

  // --- Tab Management ---
  function openTab(evt, tabName) {
    var i, tabcontent, tablinks;
    tabcontent = document.getElementsByClassName("tab-content");
    for (i = 0; i < tabcontent.length; i++) {
      tabcontent[i].style.display = "none";
      tabcontent[i].classList.remove('active');
    }
    tablinks = document.getElementsByClassName("tab-button");
    for (i = 0; i < tablinks.length; i++) {
      tablinks[i].className = tablinks[i].className.replace(" active", "");
    }

    const selectedTab = document.getElementById(tabName);
    if (selectedTab) {
      selectedTab.style.display = "block";
      selectedTab.classList.add('active');
    }
    if (evt) { // Only add active class if clicked
      evt.currentTarget.className += " active";
    } else { // For initial load, set active class on the default button
      const defaultButton = document.querySelector(`.tab-button[onclick*='${tabName}']`);
      if (defaultButton) {
        defaultButton.className += " active";
      }
    }

    // Render charts if "Analisis Visual" tab is opened AND data is available
    if (tabName === 'analisisVisual' && window.dashboardData) {
      renderCharts(window.dashboardData);
    } else {
      // Destroy charts if switching away from Analisis Visual tab
      for (const chartId in currentCharts) {
        if (currentCharts[chartId]) {
          currentCharts[chartId].destroy();
          currentCharts[chartId] = null;
        }
      }
    }
  }

  function openAbsensiTab(evt, tabName) {
    let i, tabcontent, tabbuttons;

    tabcontent = document.getElementsByClassName("tab-content-absensi");
    for (i = 0; i < tabcontent.length; i++) {
      tabcontent[i].style.display = "none";
    }

    tabbuttons = document.getElementsByClassName("tab-button-absensi");
    for (i = 0; i < tabbuttons.length; i++) {
      tabbuttons[i].className = tabbuttons[i].className.replace(" active", "");
    }

    const selectedTab = document.getElementById(tabName);
    if (selectedTab) {
      selectedTab.style.display = "block";
      selectedTab.classList.add('active');
    }

    if (evt) { // Only add active class if clicked
      evt.currentTarget.className += " active";
    } else { // For initial load, set active class on the default button
      const defaultButton = document.querySelector(`.tab-button-absensi[onclick*='${tabName}']`);
      if (defaultButton) {
        defaultButton.className += " active";
      }
    }

  }

  
  function openReportTab(evt, tabName) {
    let i, tabcontent, tabbuttons;

    tabcontent = document.getElementsByClassName("tab-content-laporan");
    for (i = 0; i < tabcontent.length; i++) {
      tabcontent[i].style.display = "none";
    }

    tabbuttons = document.getElementsByClassName("tab-button-laporan");
    for (i = 0; i < tabbuttons.length; i++) {
      tabbuttons[i].className = tabbuttons[i].className.replace(" active", "");
    }

    const selectedTab = document.getElementById(tabName);
    if (selectedTab) {
      selectedTab.style.display = "block";
      selectedTab.classList.add('active');
    }

    if (evt) { // Only add active class if clicked
      evt.currentTarget.className += " active";
    } else { // For initial load, set active class on the default button
      const defaultButton = document.querySelector(`.tab-button-laporan[onclick*='${tabName}']`);
      if (defaultButton) {
        defaultButton.className += " active";
      }
    }

  }
 
  
  function openGajiTab(evt, tabName) {
    let i, tabcontent, tabbuttons;

    tabcontent = document.getElementsByClassName("tab-content-gaji");
    for (i = 0; i < tabcontent.length; i++) {
      tabcontent[i].style.display = "none";
    }

    tabbuttons = document.getElementsByClassName("tab-button-gaji");
    for (i = 0; i < tabbuttons.length; i++) {
      tabbuttons[i].className = tabbuttons[i].className.replace(" active", "");
    }

    const selectedTab = document.getElementById(tabName);
    if (selectedTab) {
      selectedTab.style.display = "block";
      selectedTab.classList.add('active');
    }

    if (evt) { // Only add active class if clicked
      evt.currentTarget.className += " active";
    } else { // For initial load, set active class on the default button
      const defaultButton = document.querySelector(`.tab-button-gaji[onclick*='${tabName}']`);
      if (defaultButton) {
        defaultButton.className += " active";
      }
    }

  }

  // --- Chart Rendering Functions ---
  function renderCharts(data) {
    // Destroy existing charts before rendering new ones
    for (const chartId in currentCharts) {
      if (currentCharts[chartId]) {
        currentCharts[chartId].destroy();
        currentCharts[chartId] = null;
      }
    }

    if (!data || !data.performanceData || data.performanceData.length === 0) {
      console.warn("Tidak ada data performance untuk merender grafik.");
      // Optionally display a message in the chart areas (clear canvas)
      const chartIds = ['performanceChart', 'inflowChart', 'prospectChart', 'closingChart'];
      chartIds.forEach(id => {
        const canvas = document.getElementById(id);
        if (canvas) {
          const ctx = canvas.getContext('2d');
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          // Optional: Add text like "No data available" on the canvas
          ctx.font = "16px Arial";
          ctx.textAlign = "center";
          ctx.fillStyle = "#888";
          ctx.fillText("Tidak ada data untuk grafik ini.", canvas.width / 2, canvas.height / 2);
        }
      });
      return;
    }

    const marketingNames = data.performanceData.map(item => item.name);
    const performancePercentages = data.performanceData.map(item => item.performance);
    const totalInflows = data.performanceData.map(item => item.inflow);
    const totalProspects = data.performanceData.map(item => item.totalProspect);
    const totalClosings = data.performanceData.map(item => item.totalClosing);

    // Chart 1: Performance (%) Marketing
    const performanceCtx = document.getElementById('performanceChart').getContext('2d');
    currentCharts.performanceChart = new Chart(performanceCtx, {
      type: 'bar',
      data: {
        labels: marketingNames,
        datasets: [{
          label: 'Pencapaian (%)',
          data: performancePercentages,
          backgroundColor: 'rgba(75, 192, 192, 0.6)',
          borderColor: 'rgba(75, 192, 192, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Pencapaian (%)'
            },
            ticks: {
              callback: function(value) {
                return value + '%';
              }
            }
          },
          x: {
            title: {
              display: true,
              text: 'Nama Marketing'
            }
          }
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: function(context) {
                let label = context.dataset.label || '';
                if (label) {
                  label += ': ';
                }
                if (context.parsed.y !== null) {
                  label += context.parsed.y.toFixed(2) + '%';
                }
                return label;
              }
            }
          }
        }
      }
    });

    // Chart 2: Total Inflow per Marketing
    const inflowCtx = document.getElementById('inflowChart').getContext('2d');

    currentCharts.inflowChart = new Chart(inflowCtx, {
      type: 'bar',
      data: {
        labels: marketingNames,
        datasets: [{
          label: 'Total Inflow (Rp)',
          data: totalInflows,
          backgroundColor: 'rgba(153, 102, 255, 0.6)',
          borderColor: 'rgba(153, 102, 255, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Total Inflow (Rp)'
            },
            ticks: {
              callback: function(value) {
                return formatCurrency(value);
              }
            }
          },
          x: {
            title: {
              display: true,
              text: 'Nama Marketing'
            }
          }
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: function(context) {
                let label = context.dataset.label || '';
                if (label) {
                  label += ': ';
                }
                if (context.parsed.y !== null) {
                  label += formatCurrency(context.parsed.y);
                }
                return label;
              }
            }
          }
        }
      }
    });

    // Chart 3: Total Prospect per Marketing
    const prospectCtx = document.getElementById('prospectChart').getContext('2d');
    currentCharts.prospectChart = new Chart(prospectCtx, {
      type: 'bar',
      data: {
        labels: marketingNames,
        datasets: [{
          label: 'Total Prospect',
          data: totalProspects,
          backgroundColor: 'rgba(255, 159, 64, 0.6)',
          borderColor: 'rgba(255, 159, 64, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Jumlah Prospect'
            },
            ticks: {
              precision: 0
            }
          },
          x: {
            title: {
              display: true,
              text: 'Nama Marketing'
            }
          }
        }
      }
    });

    // Chart 4: Total Closing per Marketing
    const closingCtx = document.getElementById('closingChart').getContext('2d');
    currentCharts.closingChart = new Chart(closingCtx, {
      type: 'bar',
      data: {
        labels: marketingNames,
        datasets: [{
          label: 'Total Closing',
          data: totalClosings,
          backgroundColor: 'rgba(255, 99, 132, 0.6)',
          borderColor: 'rgba(255, 99, 132, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Jumlah Closing'
            },
            ticks: {
              precision: 0
            }
          },
          x: {
            title: {
              display: true,
              text: 'Nama Marketing'
            }
          }
        }
      }
    });

     
  }
</script>